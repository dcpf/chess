<!DOCTYPE html>
<!-- Copyright (c) 1998 - 2013 dpf, dpf@theworld.com -->
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="description" content="Dave's Chess-By-Email - Internet Correspondence Chess">
    <meta name="keywords" content="chess-by-email, chess by email, play chess, correspondence chess">
    <meta name="author" content="David Piersol-Freedman 1998">
    <title>Dave's Chess-By-Email</title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css">
    <link rel="stylesheet" href="css/chess.css?ver=<%= runtimestamp %>" />
</head>
<body style="padding: 20px">

    <!-- Create/enter view -->
    <div id="enterGameView" style="display: none">
        <form>
            <h3>Welcome to Dave's Chess-By-Email</h3>
            <hr/>
            <table id="enterGameTable">
                <tr>
                    <td colspan="2"><input type="radio" name="newOrExisting" value="N">New Game</td>
                </tr>
                <tr>
                    <td>Your Email Address</td>
                    <td><input type="text" id="player1Email" maxlength="50"></td>
                </tr>
                <tr>
                    <td>Opponent's Email Address</td>
                    <td><input type="text" id="player2Email" maxlength="50"></td>
                </tr>
                <tr><td colspan="2"><hr></td></tr>
                <tr>
                    <td colspan="2"><input type="radio" name="newOrExisting" value="E">Continue Existing Game</td>
                </tr>
                <tr>
                    <td>Existing Game Name</td>
                    <td><input type="text" id="gameID"></td>
                </tr>
                <tr>
                    <td>Pass Code</td>
                    <td><input type="password" id="key"></td>
                </tr>
                <!--tr>
                    <td colspan="2"><a href="forgot_passcode.pl">Forgot Your Pass Code?</a></td>
                </tr-->
                <tr>
                    <td colspan="2" align="center" style="padding-top: 40px">
                        <input type="button" value="Submit" id="enterGameSubmitButton">&nbsp;
                        <input type="reset" value="Clear">
                    </td>
                </tr>
            </table>
        </form>
    </div>

    <!-- move history container -->
    <div id="moveHistoryContainer" style="visibility: hidden">
        <div id="replayGameLink"><a href="#">Auto-Replay</a></div>
        <table id="moveHistoryTable">
            <tr>
                <th style="border-bottom: none; width: 20px;"></th>
                <th style="border-right: solid 1px #000" class="currentPlayer">White</th>
                <th>Black</th>
            </tr>
        </table>
    </div>

    <!-- chess board -->
    <div style="display: inline-block">
        <div id="chessBoardContainer"></div>
        <div id="messageContainer"></div>
        <fieldset id="capturedPiecesContainer" style="visibility: hidden">
            <legend>Captured Pieces</legend>
            <div id="capturedBlackPieces"></div>
            <div id="capturedWhitePieces"></div>
        </fieldset>
    </div>

</body>

<!-- dialogs -->

<div id="confirmMoveDialog" class="modal hide" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-body">
        <p>Please verify your move</p>
        <div id="possibleMoves"></div>
    </div>
</div>

<div id="chessBoardSnapshotDialog" class="modal hide" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-body">
        <div style="text-align: right"><a href="#" class="closeIcon">Close</a></div>
        <div class="move"></div>
        <div id="chessBoardSnapshotContainer"></div>
    </div>
    <div id="tempPiecePlaceHolder"></div>
</div>

<div id="genericDialog" class="modal hide" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>&nbsp;</h3>
  </div>
    <div class="modal-body" style="padding: 0 20px 15px 20px">
        <p class="genericDialogText"></p>
    </div>
</div>

<script>
//window.oncontextmenu = function () {return false;};
function log (msg) {
    if (window.console) {
        console.log(msg);
    }
}
</script>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>

<!-- load utils -->
<script src="js/util/eventHandler.js?ver=<%= runtimestamp %>"></script>
<script src="js/util/notationConverter.js?ver=<%= runtimestamp %>"></script>

<!-- load models -->
<script src="js/model/piece.js?ver=<%= runtimestamp %>"></script>
<script src="js/model/board.js?ver=<%= runtimestamp %>"></script>

<!-- load collections -->
<script src="js/collection/capturedPieces.js?ver=<%= runtimestamp %>"></script>
<script src="js/collection/moveHistory.js?ver=<%= runtimestamp %>"></script>

<!-- load views -->
<script src="js/view/enterGameView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/boardView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/boardSnapshotView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/genericDialogView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/confirmMoveDialogView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/capturedPiecesView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/moveHistoryView.js?ver=<%= runtimestamp %>"></script>
<script src="js/view/messagesView.js?ver=<%= runtimestamp %>"></script>

<!-- load the initializer -->
<script src="js/util/initializer.js?ver=<%= runtimestamp %>"></script>

<script>

// Set some required variables
chess.vars = {
    gameID: '<%= gameID %>',
    key: '<%= key %>',
    initialMoveHistory: <%= initialMoveHistory %>,
    canMove: <%= canMove %>
};

// Instantiate the chessGame object, eventHandler, and enterGameView. This is all we need for the initial UI.
var chessGame = {};
chessGame.eventHandler = new chess.EventHandler();
chessGame.enterGameView = new chess.EnterGameView({
    eventHandler: chessGame.eventHandler
});

function startGame (attrs) {

    // if attrs were passed in, update chess.vars
    if (attrs) {
        // initialMoveHistory is a string, so we need to get it back into json format before assigning to chess.vars
        attrs.initialMoveHistory = JSON.parse(attrs.initialMoveHistory);
        chess.vars = attrs;
    }

    // kick things off
    chess.initializer.initialize(chessGame, chess.vars.canMove);
    chessGame.board.findAllLegalMoves();
    chessGame.boardView.render();

    // If there is an existing move history, use it to get the game into the current state
    for (var i in chess.vars.initialMoveHistory) {
        var notation = chess.vars.initialMoveHistory[i];
        var moveArray = chessGame.notationConverter.convertNotation(chessGame.board, notation, i);
        for (var j in moveArray) {
            var move = moveArray[j];
            chessGame.boardView.doMove(move.piece.id, move.toRow, move.toCol, false);
            chessGame.boardView.updateGameWithLatestMove(notation, move.piece.id, move.toRow, move.toCol);
        }
    }

    // Show hidden widgets
    $('#moveHistoryContainer').css('visibility', 'visible');
    $('#capturedPiecesContainer').css('visibility', 'visible');
}

// If the page has loaded with a gameID and key, start the game. This will occur when the following URL params are passed in: ?gameID=yl9pqqgamdgd&key=123456
if (chess.vars.gameID && chess.vars.key) {
    chessGame.enterGameView.hide();
    startGame();
} else {
    chessGame.enterGameView.show();
}

</script>


</html>
